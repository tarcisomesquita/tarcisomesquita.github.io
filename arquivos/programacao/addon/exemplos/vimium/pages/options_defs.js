import{CurCVer_ as t,OnChrome as e,OnFirefox as i,$ as s,$$ as n,nextTick_ as l,post_ as o,enableNextTick_ as r,toggleReduceMotion_ as a,OnEdge as h,CurFFVer_ as u,OnSafari as p,prevent_ as f,bTrans_ as c}from"./async_bg.js";import{bgSettings_ as _,Option_ as d,ExclusionRulesOption_ as m,oTrans_ as O,delayBinding_ as x}from"./options_base.js";d.U=[],d.prototype.F=function(t){let e=t.call(this);if(this.K==="passEsc"||this.K==="ignoreReadonly")this.M||this.A(e);else if(VApi&&!this.M){let t=_.B[this.K];(t in _.T?o(3,{key:t,val:e}):Promise.resolve(e)).then(i=>{var s;if(VApi.z[t]=i!=null?i:e,t==="l"){let s=VApi.y().r;s&&s.querySelector("iframe.Omnibar")&&o(29,{key:t,val:i!=null?i:e})}(s=d.Y)===null||s===void 0||s.call(d)})}},d.prototype.D=function(t){let e=t.call(this);if(this.M);else if(this.K==="autoReduceMotion"){let t=e===1||e!==0&&matchMedia("(prefers-reduced-motion: reduce)").matches;VApi&&(VApi.z.m=t),a(t)}else this.C()},d.at=async()=>{let t=d.X,e=[];_.v();let i=t.optionalPermissions,s=i&&i.x();await Promise.all([_.E(),s]);for(let i in t){let s=t[i];!s.L&&s.G()&&e.push(s.ut())}if(e.length>0&&!confirm(O("dirtyOptions",[e.join("\n  * ")])))return!1;for(let e in t){let i=t[e];if(!i.L&&!i.I())return!1}r(8),t.vimSync.L||await t.vimSync.x(),t.exclusionRules.L||await t.exclusionRules.x();let n=[];for(let e in t){let i=t[e];i.L||n.push(i.x())}return await Promise.all(n),r(0,8),!0},d.pt=()=>{let t=d.X;for(let e in t)if(!t[e].L)return!0;return!1},d.prototype.ut=function(){let t=this.P;return this instanceof BooleanOption_?t.nextElementSibling.textContent:(t=t.closest("tr"),t=t.querySelector(".caption"),t.innerText.replace(/[\r\n]/g,""))};export class NumberOption_ extends d{e(){let t,e;this.q={min:(t=this.P.min)&&!isNaN(e=parseFloat(t))?e:null,max:(t=this.P.max)&&!isNaN(e=parseFloat(t))?e:null,default:0,Z:NumberOption_.ft},x(this.P,"input",this.J),x(this.P,"focus",this.ct.bind(this)),l(()=>{this.q.default=_.O[this.K]})}c(t){this.P.value=""+t}R(){return Math.round(parseFloat(this.P.value))}ct(){let t=this.P,e=t=>this._t(t),i=()=>{t.removeEventListener("wheel",e,{passive:!1}),t.removeEventListener("blur",i),this.dt=0};this.dt=0,t.addEventListener("wheel",e,{passive:!1}),t.addEventListener("blur",i)}_t(t){f(t);let e=this.dt,i=Date.now();if(i-e<100&&i+99>e&&e)return;this.dt=i;let s,n=this.P,l=(t.deltaY||t.deltaX)>0,o=n.value,r=l?n.stepUp:n.stepDown;if(typeof r=="function")r.call(n),s=n.value,n.value=o;else{r=parseFloat;let t=r(n.step)||1;i=(+n.value||0)+(l?t:-t),isNaN(t=r(n.max))||(i=Math.min(i,t)),isNaN(t=r(n.min))||(i=Math.max(i,t)),s=""+i}return this.mt(s,e>0,!1)}static ft(t){return isNaN(t)&&(t=this.default),t=this.min!=null?Math.max(this.min,t):t,this.max!=null?Math.min(this.max,t):t}}export class BooleanOption_ extends d{e(){let t=this.P,e=t.dataset.map;this.Ot=e?JSON.parse(e):t.dataset.allowNull?BooleanOption_.xt:BooleanOption_.gt,this.Nt=this.Ot.length-1,this.Nt>1&&this.K!=="vimSync"&&x(t,"input",this.onTripleStatusesClicked.bind(this),!0),x(t,"change",this.J)}c(t){let e=t===!0||t===this.Ot[this.Nt];this.P.checked=e,this.P.indeterminate=this.Nt>1&&t===this.Ot[1],this.bt=e?this.Nt:Math.max(0,this.Ot.indexOf(t))}R(){return this.P.indeterminate?this.Ot[1]:this.Ot[this.P.checked?this.Nt:0]}onTripleStatusesClicked(t){this.bt=BooleanOption_.ToggleTripleStatuses(this.bt,t)}static ToggleTripleStatuses(t,e){let i=e.target;f(e);let s=t===2?1:t?0:2;return i.indeterminate=t===2,i.checked=s===2,s}A(t){return this.P.dataset.map&&typeof t=="boolean"&&(t=this.Ot[t?this.Nt:0]),t}static Tt(t,e){t.disabled=e;let i=t.nextElementSibling;i.tabIndex=e?-1:0,e?i.setAttribute("aria-disabled","true"):i.removeAttribute("aria-disabled")}}BooleanOption_.gt=[!1,!0],BooleanOption_.xt=[!1,null,!0];export class TextOption_ extends d{constructor(){super(...arguments),this.Bt=!1}e(){let t=this.P.dataset.converter||"",e=t?t.split(" "):[];x(this.P,"input",this.J),e.length>0&&(this.q={St:e,p:0,Z:TextOption_.vt})}j(){let t=super.j(),e=this.q;return e&&(e.p=0,t?t=t.then(()=>{e.p=e.Z(this.z)===this.z?1:0}):e.p=e.Z(this.z)===this.z?1:0),t}c(t,e){let i=this.Et(t);e!==!0?this.P.value=i:this.mt(i,!0,!0)}wt(){return this.P.value.trim().replace(/\xa0/g," ")}Et(t){return t}R(){let t=this.wt(),e=this.q;return t&&e&&e.Z===TextOption_.vt&&(e.p|=2,t=TextOption_.vt.call(e,t),e.p&=-3),t}W(t){return this.Et(t)!==this.wt()}ae(t,e){let i=!!t;(i||this.Bt)&&(this.Bt=i,TextOption_.ae(t,e,this.P))}static ae(t,e,i){let s=!!t,{classList:n}=i,o=i.nextElementSibling;o=o&&o.classList.contains("tip")?o:null,(s||o)&&l(()=>{s?(o==null&&(o=document.createElement("div"),o.className="tip",i.after(o)),o.textContent=t,e!==null&&n.add(e||"has-error")):(n.remove("has-error"),n.remove("highlight"),o&&o.remove())})}static vt(t){let e=this.St;if(e.indexOf("lower")>=0?t=t.toUpperCase().toLowerCase():e.indexOf("upper")>=0&&(t=t.toLowerCase().toUpperCase()),t=t.normalize(),e.indexOf("chars")<0||this.p&2&&!(this.p&1))return t;let i="";for(let e of t.replace(/\s/g,""))i.includes(e)||(i+=e);return i}}export class NonEmptyTextOption_ extends TextOption_{R(){return this.P.value.trim()||this.c(_.O[this.K],!0),super.R()}}export class CssSelectorOption_ extends NonEmptyTextOption_{wt(){return super.wt().replace(/:default\([^)]*\)/,":default")}Et(t){return(t=t.replace(/(?:^# |\/\/)[^\n]*|([,>] ?)(?!$|\n)/g,(t,e)=>e?e!==">"?", ":" > ":t)).replace(/(^|\n):default(?!\()(, \S)?/,(t,e,i)=>{let s=`:default(${this.getRealDefault()})`;return e+CssSelectorOption_.ce(s)+(i?",\n"+i[2]:"")})}getRealDefault(){return c(this.K==="passEsc"?"121":"120")}static ce(t){let e=t.indexOf("##"),i=e>=0?t.slice(0,e+2):"",s="";t=(t=e>=0?t.slice(e+2):t).replace(/,|>/g,t=>t===","?", ":" > ").trimRight();for(let e of t.split(", "))i&&i.length+e.length>62?(s=i.endsWith("#")?i:(s?s+"\n":"")+i+",",i="  "+e):i=i?i+(i.endsWith("#")?"":", ")+e:e;return i?(s?s+"\n":"")+i.trimRight():s}}export class JSONOption_ extends TextOption_{Et(t){let e=this.P instanceof HTMLInputElement,i=JSON.stringify(t,null,e?1:2);return e?i.replace(/(,?)\n\s*/g,(t,e)=>e?", ":""):i}R(){let t=super.R(),e=null;if(t)try{e=JSON.parse(t)}catch(t){}else e=_.O[this.K],this.c(e,!0);return e}static yt(t){if(!t||typeof t!="object")return t;if(t instanceof Array)return t.map(JSONOption_.yt);let e={};for(let i of Object.keys(t).sort())e[i]=JSONOption_.yt(t[i]);return e}Q(t,e){return JSON.stringify(t)===JSON.stringify(JSONOption_.yt(e))}A(t){return JSONOption_.yt(t)}}export class MaskedText_ extends TextOption_{e(){super.e(),this.kt=!0,this.Mt=this.Vt.bind(this),x(this.P,"focus",this.Mt)}Vt(){this.Mt&&(this.P.removeEventListener("focus",this.Mt),this.P.classList.remove("masked"),this.Mt=null,this.kt=!1,this.P.removeAttribute("placeholder"),this.j())}c(t,e){this.kt?this.P.placeholder=O("clickToUnmask"):super.c(t,e)}wt(){return this.kt?this.z:super.wt()}}TextOption_.prototype.mt=NumberOption_.prototype.mt=function(t,e,i){let s=this.P,n=s.value,l=s.selectionDirection!=="backward"?s.selectionEnd:s.selectionStart,o=!1;if(e&&(this.M=!0,o=document.activeElement!==s,o&&s.focus(),document.execCommand("undo")),this.M=i,l==null)s.select(),document.execCommand("insertText",!1,t),o&&this.P.blur();else{let i=e?s.value:n,r=s.scrollLeft,a=s.scrollTop,h=0,u=i.length-1,p=t.length-1,f=Math.min(u,p);for(;h<=f&&i[h]===t[h];)h++;for(f=Math.max(h,u-(p-h));f<=u&&i[u]===t[p];)u--,p--;s.setSelectionRange(h,u+1);let c=t.slice(h,p+1);if(document.execCommand("insertText",!1,c),o&&s.blur(),n!==i){for(h=0,u=n.length-1,p=t.length-1,f=Math.min(u,p);h<=f&&n[h]===t[h];)h++;for(f=Math.max(h,u-(p-h));f<=u&&n[u]===t[p];)u--,p--}if(l)if(l===n.length)r=s.scrollWidth,a=s.scrollHeight,l=t.length;else if(l<h);else if(l>u)l+=p-u;else{let e=n.slice(0,l).split("\n"),i=e.length,s=t.split("\n").slice(0,i);s.length===i&&(s[i-1]=s[i-1].slice(0,e[i-1].length)),l=s.reduce((t,e)=>t+e.length,0)+s.length-1}else r=a=0;s.scrollTo(r,a),s.setSelectionRange(l,l)}this.M=!1},m.prototype.nt=function(t){if(this.h.length!==t)return;let e=s("#exclusionToolbar"),i=n("[data-model]",e);e.style.visibility=t?"":"hidden";for(let e of i){let i=d.X[e.id],s=i.P.parentNode.style;s.visibility=t||i.L?"":"visible",s.display=!t&&i.L?"none":""}};export const saveBtn_=s("#saveOptions");export const exportBtn_=s("#exportButton");export let savedStatus_;export let registerClass_;export const createNewOption_=(()=>{let t=!1;savedStatus_=e=>t=e!=null?e:t;let e=function(){if(this.M)return;let e=this.R();return(this.L=this.Q(this.z,e))?(t&&!d.pt()&&(saveBtn_.blur(),saveBtn_.disabled=!0,saveBtn_.firstChild.data=O("115"),exportBtn_.disabled=!1,savedStatus_(!1),window.onbeforeunload=null),e):(t||(window.onbeforeunload=C,savedStatus_(!0),saveBtn_.disabled=!1,saveBtn_.firstChild.data=O("115_2"),exportBtn_.blur(),exportBtn_.disabled=!0),e)},i={Number:NumberOption_,Boolean:BooleanOption_,Text:TextOption_,NonEmptyText:NonEmptyTextOption_,JSON:JSONOption_,MaskedText:MaskedText_,ExclusionRules:m,CssSelector:CssSelectorOption_},s=t=>{let s=new(0,i[t.dataset.model])(t,e);return d.X[s.K]=s};d.V=!0;for(let t of n('[data-model]:not([data-model=""])'))s(t);return registerClass_=(t,e)=>{i[t]=e},s})();{let t=d.X.exclusionRules,e=t.l;e.ondragstart=e=>{let i=e.target,s=document.activeElement;s.localName!=="input"?(t.Jt=i,i.style.opacity="0.5",e.dataTransfer.setData("text/plain","")):s!==i&&f(e)},e.ondragend=()=>{let e=t.Jt;t.Jt=null,e&&(e.style.opacity="")},e.ondragover=e=>{t.Jt&&f(e)},e.ondrop=e=>{f(e);let i=t.Jt;if(!i)return;let s=e.target;if(s=s.closest(".exclusionRule"),!s||i===s)return;s.before(i);let n=t.h,l=i.querySelector(".pattern").vnode,o=s.querySelector(".pattern").vnode;n.splice(n.indexOf(l),1),n.splice(n.indexOf(o),0,l),t.J()}}let g=d.X.keyMappings,N=t=>{let e,i=new RegExp("^#![^\\n]*|^[^]","gm");for(;e=i.exec(t);){let i=e[0];if(i&&i[0]!=="\n"){if(i[0]!=="#")break;if(i[1]==="!"&&i.slice(2).trim()==="no-check"){t=t.slice(0,e.index)+t.slice(e.index+i.length).trimLeft();break}}}return t.replace(/\.activateMode(?:To)?/g,".activate")};g.H=function(){let t=d.prototype.H.call(this);return t instanceof Promise?t.then(N):N(t)},g.A=function(t){return t=N(t),d.prototype.A.call(this,t)};export const onKeyMappingsError_=t=>{t===!0?g.ae(O("ignoredNonEN"),null):g.ae(t)};let b=d.X.linkHintCharacters,T=d.X.linkHintNumbers,B=d.X.filterLinkHints;b.C=T.C=function(){this.ae(!this.P.style.display&&this.z.length<4?"Too few characters for LinkHints":"")},B.C=()=>{l(()=>{let t=B.R();T.P.style.display=t?"":"none",b.P.style.display=t?"none":"",BooleanOption_.Tt(d.X.waitForEnter.P,!t),b.C(),T.C()})},x(B.P,"change",B.C,!0);let S,v=d.X.keyLayout,[E,w,y,k,M,V]=n("input",v.P);v.R=()=>{let t=0;E.checked?t=1:(t|=w.checked?8:0,t|=y.checked?2:y.indeterminate?4:0,t|=k.checked?16:k.indeterminate?512:0),t|=M.checked?128:M.indeterminate?64:0,t|=V.checked?32:0;let e=v.z;return e&256&&(e&-257)===t&&(t|=256),t};let J=!0;v.c=t=>{let e=!!(t&1);E.checked=e,w.checked=e||!!(t&8),y.checked=e||!!(t&2),y.indeterminate=!!(t&4),k.checked=e||!!(t&16),k.indeterminate=!!(t&512),V.checked=!!(t&32),M.checked=!!(t&128),M.indeterminate=!!(t&64),S=t,A(),d.Y&&o(3,{key:"l",val:t}).then(e=>{VApi.z.l=e!=null?e:t,d.Y()})};let A=t=>{let e=E.checked;if(BooleanOption_.Tt(w,e),BooleanOption_.Tt(y,e),BooleanOption_.Tt(k,e),t)if(e)w.checked=y.checked=k.checked=!0,y.indeterminate=k.indeterminate=!1;else{let e=v.H();typeof e!="number"||S&1||(S===e?v.j():v.c(S),t.stopImmediatePropagation(),l(v.J))}};x(v.P,"input",t=>{let e=t.target;if(e===E)A(t);else{let i=e===y?4:e===k?512:e===M?64:0,s=e===y?2:e===k?16:e===M?128:8;if(i){let e=BooleanOption_.ToggleTripleStatuses(S&s?2:S&i?1:0,t);S=S&~(i|s)|(e>1?s:e?i:0)}else S=S&~s|(e.checked?s:0)}},!0),d.X.vomnibarPage.C=function(){let t=this.z;t.startsWith(location.protocol)||t.startsWith("front/")?this.ae(""):t.startsWith("file:")?this.ae(O("fileVomnibar"),"highlight"):/^http:\/\/(?!localhost[:/])/i.test(t)?this.ae(O("httpVomnibar"),"highlight"):this.ae("")},d.X.userDefinedCss.C=function(){this.P.classList.contains("debugging")&&l(()=>{let t=VApi.y().r;for(let e of n("iframe",t)){let t=e.classList.contains("HUD"),i=e.contentDocument.querySelector("style.debugged");i&&(t?i.remove():i.classList.remove("debugged"))}this.P.classList.remove("debugging")})},d.X.autoReduceMotion.C=function(){l(()=>{let t=this.z;a(t===2?matchMedia("(prefers-reduced-motion: reduce)").matches:t>0)})};let C=()=>(setTimeout(()=>{setTimeout(()=>{for(let t of Object.values(d.X)){if(t instanceof TextOption_&&t.Bt)continue;let e=t.P;if(e.localName==="input"&&e.type==="checkbox"){let t=e.parentElement,i=t.parentElement;e=i.localName==="td"?i:t}e.classList.toggle("highlight",!t.L)}},300)},17),O("beforeUnload"));