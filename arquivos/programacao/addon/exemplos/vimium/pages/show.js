async function e(){ee&&(w(),te.style.display="none",ee.remove(),ee=null),VData=window.VData=Object.create(null);let e,i=location.hash,r="",f="";if(D||!i&&J&&(e=await O(17))){i=D||e,D="",/^[^:]+[ &]data:/i.test(i)&&(re=-1),re=re||Math.floor(Math.random()*4294967296)||3286711320;let t=I(i,re,!0);history.state?history.pushState(t,"",""):history.replaceState(t,"",""),window.name=""+re}else i||!history.state||(re?(i=I(history.state,re,!1),window.name=""+re):history.replaceState(null,"",""));VData.full=i,i.length<3||(i.startsWith("#!image")?(i=i.slice(7),r="image"):/^#!(url|text)\b/.test(i)&&(r=i[2]==="u"?"url":"text",i=i.slice(r==="url"?5:6))),i=i.startsWith("%20")?i.slice(3):i.trim();for(let e=0;e=i.indexOf("&")+1;i=i.slice(e)){let t=i.slice(0,e).indexOf("="),n=t>0?i.slice(0,t):"",r=t>0?i.slice(t+1,e-1):"";if(n==="download")f=o(r).split(/\||\uff5c| [-\xb7] /,1)[0].trim(),f=f.replace(/[\r\n"]/g,""),VData.file=f;else if(n==="src")VData.rawSrc=o(r);else if(r=r.toLowerCase(),n==="auto")VData.auto=r==="once"?r:r==="true"||r!=="false"&&parseInt(r,10)>0;else if(n==="pixel")VData.pixel=r==="1"||r==="true";else{if(n!=="incognito")break;VData.incognito=r==="true"||r!=="false"&&parseInt(r,10)>0}}{let e=o(i,i.includes(":")||i.includes("/")?decodeURI:null);i=(e==i||/[%\n]/.test(e)?i:e).trim()}if(i)if(i.toLowerCase().startsWith("javascript:"))r=i=f=VData.file="";else if(J){let e=await O(10,[i,-2]);e[1]<=2&&(i=e[0])}else i.startsWith("//")?i="http:"+i:/^([-.\dA-Za-z]+|\[[\dA-Fa-f:]+])(:\d{2,5})?\//.test(i)&&(i="http://"+i);else r==="image"&&(r="");switch(VData.type=r,/^data:/i.test(i)&&(i="data:"+i.slice(5).replace(/#/g,"%23")),VData.url=VData.original=i,r){case"image":if(VData.auto){let e=/^(blob|data):/i.test(i.slice(0,5))&&VData.rawSrc||i,t=await b(J&&await O(18,[e,256])||e,e);t&&(console.log("Auto predict a better URL:\n %o =>\n %o",i,t),i=VData.url=t)}if(ee=l("shownImage"),ee.onerror=function(){VData.url!==VData.original&&VData.url?T():(k(),VData.auto=!1,this.onerror=this.onload=null,this.alt=VData.error=sTrans_("failInLoading"),this.classList.add("broken"),setTimeout(t,34),this.onclick=async e=>{J&&await O(19,VData.url)||(e.ctrlKey||e.shiftKey||e.altKey||!S.tabs||!S.tabs.update?n({target:"_top"},e):S.tabs.update({url:VData.url}))})},/[:.]/.test(i)){ee.alt=sTrans_("loading"),ee.onclick=a,ee.onload=function(){let e=this.naturalWidth,n=this.naturalHeight;if(e<12&&n<12){if(VData.auto)return void T();if(e<2&&n<2)return console.log("The image is too small to see."),void this.onerror(null)}VData.original=VData.url,k();let i=VData.url.slice(0,6).toLowerCase(),r=i.startsWith("blob:");if((r||i.startsWith("data:")&&!this.src.startsWith("data"))&&(te.dataset.vimUrl=VData.original=VData.url=this.src,R(r?0:1)),this.onerror=this.onload=null,this.src.startsWith("blob:")||setTimeout(()=>{ee.src=ee.src},0),t(),this.alt=f,this.classList.add("zoom-in"),VData.pixel){Q.classList.add("pixel");let t=devicePixelRatio;if(e>innerWidth*t*.9&&n>innerHeight*t*.9){let e=l("snapshot-banner",!0);e.querySelector(".banner-close").onclick=()=>{e.remove()};let t=e.querySelectorAll("[data-i]");for(let e=0;e<t.length;e++){let n=t[e].dataset.i,i=n.endsWith("-t"),r=P(i?n.slice(0,-2):n);r&&(i?t[e].title=r:t[e].textContent=r)}Q.prepend(e)}}e>=innerWidth*.9&&Q.classList.add("filled")};let e=await fe(i);x(i,ee,e)}else i=VData.url="",ee.onerror(null),ee.alt=VData.error=sTrans_("none");if(f){VData.file=f=y(f)||f;let e=f.split(/[/\\]+/);e.length>1&&ee.setAttribute("download",e[e.length-1]),ee.setAttribute("aria-title",f)}break;case"url":case"text":if(ee=l("shownText"),i&&r!=="text"){let e=await O(16,i);if(typeof e!="string"){u(e[1],e[0]||e[2]||"");break}i=e}i=_(i)||i,u(r,i);break;default:i="",ee=l("shownImage"),ee.src="../icons/icon128.png",te.style.display="none"}te.dataset.vimUrl=i,f?(te.dataset.vimText=f,te.download=f):(te.removeAttribute("data-vim-text"),te.removeAttribute("download")),te.onclick=ee?s:a}function t(){let e=ee.scrollWidth;te.style.height=ee.scrollHeight+"px",te.style.width=e+"px",te.style.display=""}function n(e,t){if(Z(t),!VData.url)return;let n=document.createElement("a");Object.setPrototypeOf(e,null);for(let t in e)n.setAttribute(t,e[t]);n.href=VData.url,S.permissions.contains({permissions:["downloads"]},e=>{if(e){let e={url:n.href};n.download&&(e.filename=n.download),browser.downloads.download(e).catch(()=>{})}else W(n,t);return S.runtime.lastError})}function i(e){if(VData.error)return!1;let{keyCode:t}=e,n=VApi&&VApi.z?VApi.r[3]({c:" ",e,i:t,v:""},9):t===32?"space":t===13?"enter":"",i=n.slice(n.lastIndexOf("-")+1)||n&&"-";if(i==="space"||i==="enter"){if(VData.pixel){let e=document.activeElement,t=e&&document.querySelector("#snapshot-banner");if(t&&t.contains(e)){let n=t.querySelector(".banner-close");return n.contains(e)&&n.onclick(null),!0}}return Z(e),i==="enter"&&ie&&ie.isShown&&!ie.hiding&&!ie.played?ie.play(!0):ie&&ie.isShown&&!ie.hiding||W(ee,e),!0}let o=0;switch(n){case"c-=":case"m-=":case"+":case"=":case"up":o=1;break;case"left":o=-2;break;case"right":o=2;break;case"c--":case"m--":case"-":case"down":o=-1;break;default:return!1}return Z(e),e.stopImmediatePropagation(),ie&&ie.viewed?r(ie,o):(oe=!1,m().then(p).then(e=>{r(e,o)}).catch(g)),!0}function r(e,t){t===2||t===-2?e.rotate(t*45):e.zoom(t/10,!0)}function o(e,t){try{e=(t||decodeURIComponent)(e)}catch(e){}return e}function l(e,t){let n=$("#bodyTemplate"),i=document.importNode(n.content.querySelector("#"+e),!0);return t||n.before(i),i}function a(e){if(e.altKey)return e.stopImmediatePropagation(),n({download:VData.file||""},e);switch(VData.type){case"url":n({target:"_blank"},e);break;case"image":if(VData.error)return;oe=e.ctrlKey||e.metaKey,m().then(p).catch(g)}}function s(e){Z(e),ee.onclick&&ee.onclick(e)}function u(e,n){e=typeof e=="number"?["math","copy","search","ERROR","status","paste","run","url","run-one-key"][e]:e,$("#textTip").dataset.text=sTrans_(`t_${e}`)||e,$(".colon").dataset.colon=sTrans_("colon")+sTrans_("NS");let i=$("#textBody");return n?(i.textContent=typeof n!="string"?n.join(" "):n,ee.onclick=f):i.classList.add("null"),t()}function f(e){let t=getSelection(),n=""+t;if(!n||VData.type==="image"&&n.trim()===ee.alt.trim()){if(VData.type==="image"&&VData.url){if(t.type==="Range"&&!VData.url.startsWith(location.protocol))return void(VApi&&VApi.h(1,0,sTrans_("imgCopied",["HTML"])));Z(e);let n=navigator.clipboard;return void(ue!=null?Promise.resolve(ue):fetch(VData.url,{cache:"force-cache",referrer:"no-referrer"}).then(e=>e.blob()).catch(()=>(c(VData.url),0)).then(e=>ue=e)).then(e=>{if(!e)return 0;if(!globalThis.ClipboardItem)throw new Error("");let t={"image/png":e.type!=="image/png"?new Blob([e],{type:"image/png"}):e};return/^(http|ftp|file)/i.test(VData.url)&&(t["text/plain"]=new Blob([VData.url],{type:"text/plain"})),n.write([new ClipboardItem(t)])}).catch(()=>{let e=ue&&browser.clipboard;return e?ue.arrayBuffer().then(t=>e.setImageData(t,"png")):void 0}).then(e=>{VApi&&e!==0&&VApi.h(1,0,sTrans_("imgCopied",["PNG"]))},e=>{console.log("On copy image:",e),c(VData.url)})}c(VData.type==="url"?$("#textBody").textContent:VData.url,e)}}function c(e,t){e&&VApi&&(t&&Z(t),VApi.p({H:18,s:e}))}function d(e){VData.type==="image"&&(VData.error||ie&&ie.isShown&&!ie.hiding?Z(e):ee.classList.toggle("invert"))}function h(e){if($('link[href="'+e+'"]'))return;let t=document.createElement("link");return t.rel="stylesheet",t.href=e,new Promise(e=>{t.onload=()=>{t.onload=null,e()},$('link[href$="show.css"]').before(t)})}function g(e){e&&console.log("%o",e)}function m(){return X?Promise.resolve(X):Promise.all([E("../lib/viewer.js"),h("../lib/viewer.css")]).then(([e])=>{(e=e&&typeof e=="function"?e:window.Viewer).setDefaults({navbar:!1,shown(){te.style.display="none"},viewed(){ne&&ne(!0)},zoom(e){if(!le)return;let{ratio:t}=e.detail,n=ie.imageData,{width:i,height:r,naturalWidth:o,naturalHeight:l}=n,a=o*t,s=l*t,u=a-i,f=s-r;if(t===1)n.oldXY=[n.x,n.y],n.x=(innerWidth-a)/2|0,n.y=(innerHeight-s)/2|0;else{if(!n.oldXY)return;n.x=n.oldXY[0],n.y=n.oldXY[1]}n.x+=u/2,n.y+=f/2},hide(){te.style.display="",ne&&ne(!1)}});let t=e.prototype,n=t.initImage,i=t.toggle;return t.initImage=function(e){let t=[].slice.call(arguments);t[0]=function(){let t=ie&&ie.imageData;if(t){let e=t.naturalWidth,n=t.naturalHeight,i=!!document.mozFullScreenElement,r=i?window.screen.availWidth:e,o=i?window.screen.availHeight:n;if(i?e>=r&&n>=o:!oe&&t.ratio<1){let l=i?Math.max(r/e,o/n):1;t.left=t.x=i?(r-e*l)/2|0:0,t.top=t.y=i?(o-n*l)/2|0:0,t.width=Math.round(e*l),t.height=Math.round(n*l),t.ratio=l}}e.apply(this,arguments)},n.apply(this,t)},t.toggle=function(e){le=!(e||!ie||this.imageData.ratio===1&&this.imageData.oldRatio===1);let t=i.apply(this,arguments);return le=!1,t},X=e,e})}function p(e){let t=scrollX||scrollY,n=getSelection();n.type==="Range"&&n.collapseToStart();let i=ie=ie||new e(ee);return i.scrollbarWidth=0,i.hiding&&(i.isShown=!1),i.isShown||i.show(),i.hiding=!1,t&&scrollTo(0,0),i.viewed?(i.zoomTo(1),i):new Promise((e,t)=>{ne=n=>{ne=null,n?e(i):t("failed to view the image")}})}function w(){if(v(),ue=null,Y&&(Y(),Y=null),VData.type==="image"){let e=document.body.classList;ee.classList.remove("svg"),e.remove("pixel"),e.remove("filled"),ee.removeAttribute("src"),ee.onerror=ee.onload=null,ie&&(ie.destroy(),ie=null)}}async function b(e,t){function n(e){try{return new URL(e)}catch(e){}return null}function i(e){try{e=decodeURIComponent(e||"")}catch(e){}return e}let r=n(e);if(!r||!/^(ht|s?f)tp/i.test(r.protocol))return null;let{origin:o,pathname:l}=r,a=r.search;if(t=t||e,a.length>10)for(let e of a.slice(1).split("&")){let t=e.split("=",1)[0],r=e.slice(t.length+1),s=r;if(s.length>7)if(!s.includes("://")&&/%(?:3[aA]|2[fF])/.test(s)&&(s=i(s).trim()),s.includes("/")&&n(s)){if(/^(?:imgurl|mediaurl|objurl|origin(?:al)?|real\w*|src|url)$/i.test(t))return s;let e=s.split("?")[0].split("/");if(ae.test(e[e.length-1])&&!/\bthumb/i.test(t))return s}else if(t==="id"&&/&w=\d{2,4}&h=\d{2,4}/.test(a))return o+l+"?id="+r;if(t==="name"&&/^(\d{2,4}x\d{2,4}|small)$/i.test(r)&&a.toLowerCase().includes("format="))return o+l+a.replace(s,"large");if(/^(x-)?(\w+)-?process\b/i.test(t)&&r.toLowerCase().includes("image/")&&/resize|quality/i.test(r))return a=a.replace(t+"="+r,""),o+l+(a.length>1?a:"")}let s=null;if((s=/[?&]s=\d{2,4}(&|$)/.exec(a))&&a.split("=").length<=4)return o+l;let u=0;for(let e of["/revision/latest/scale-"])l.includes(e)&&(l=l.split(e)[0],u=1);a=l;let f=a.lastIndexOf("/")+1;a=a.slice(f);let c=a.lastIndexOf("@")+1||a.lastIndexOf("!")+1,d=c>2||ae.test(a),h=null;if(d){f+=c,a=a.slice(c);let e=/(?:[.\-_]|\b)(?:[1-9]\d{2,3}[a-z]{1,3}[_\-]?|[1-9]\d?[a-z][_\-]?|0[a-z][_\-]?|[1-9]\d{1,3}[_\-]|[1-9]\d{1,2}(?=[.\-_]|\b)){2,6}(?=[.\-_]|\b)/gi;for(;h=e.exec(a);s=h);if(s&&/.[_\-].|\d\dx\d/i.test(s[0])){h=ae.exec(a.slice(s.index+s[0].length)),f+=s.index;let e=s[0].length;if(h&&h.index===0&&(e+=h[0].length),a=l.slice(f+e),l.lastIndexOf("@",f+e)>=0&&a.includes("!")){let e=a.slice(a.indexOf("!")).toLowerCase();e.includes("cover")&&/^![a-z\d_\.-]+\.(avif|jpe?g|a?png|svg|webp)$/.test(e)&&(a=a.split("!")[0])}/[@!]$/.test(a||l.charAt(f-1))?a?a=a.slice(0,-1):f--:a||!h||h.index!==0||ae.test(l.slice(Math.max(0,f-6),f))||(a=h[0])}else(s=/\b([\da-f]{8,48})([_-](?:[a-z]{1,2}|\d{3,4}[whp]?))\.[a-z]{2,4}$/.exec(a))?(f+=s.index+s[1].length,a=a.slice(s.index+s[1].length+s[2].length)):(s=/\b((?:[1-9]\d{1,3}[whxyp][_\-x]?){1,2})\.[a-z]{2,4}$/.exec(a))?(f+=s.index,a=a.slice(s.index+s[1].length)):d=!1}return d||c>2?d=d||0:(s=/_(0x)?[1-9]\d{2,3}([whp]|x0)?\./.exec(a))?a=a.slice(0,s.index)+a.slice(s.index+s[0].length-1):a.startsWith("thumb_")?a=a.slice(6):/^[1-9]\d+$/.test(a)&&+a>0&&+a<640?(f--,a=""):ae.test(a)&&/^\/(small|(thumb|mw|orj)[1-9]\d{2,3})\//.test(l)?(d=!0,a="/large"+l.slice(l.indexOf("/",1)),f=0):d=0,d!==0?o+l.slice(0,f)+a:u?o+l:t!==e?e:null}function y(e){if(!e||/.\.[a-z]{3,4}\b/i.test(e))return;let t=ae.exec(VData.url);if(t)return e+t[0];let n=ue?ue.type.toLowerCase():"";if(n.startsWith("image/")){let e={jpeg:"jpg",png:0,bmp:0,svg:0,gif:0,tif:0,ico:0};for(let t in e)if(e.hasOwnProperty(t)&&n.includes(t))return e[t]||"."+t}}function x(e,t,n){let i=new Text,r=Y=()=>{t.removeEventListener("load",r),t.removeEventListener("error",r),clearTimeout(s),i.remove(),Y===r&&(Y=null)};t.addEventListener("load",r,!0),t.addEventListener("error",r,!0);let o=e.slice(0,20).toLowerCase(),l=o.startsWith("blob:"),a=o.startsWith("data:");a&&o.startsWith("data:image/svg+xml,")&&t.classList.add("svg"),n?t.src=e:(v(),Q.replaceChild(i,t),Promise.resolve(K[e]||fetch(e,l||a?{}:{cache:"no-store",referrer:"no-referrer"}).then(e=>e.blob())).then(t=>(K[e]=t,se=URL.createObjectURL(ue=t)),()=>e).then(e=>{t.src=e,i.parentNode?Q.replaceChild(t,i):Q.append(t)}));let s=setTimeout(()=>{!t.parentNode||t.scrollHeight>=24||t.scrollWidth>=80?r():i.parentNode||(t.before(i),i.data=sTrans_("loading"))},400)}function v(){se&&(URL.revokeObjectURL(se),se="")}function _(e){let t=e.split(":",1)[0];switch(t.toLowerCase()){case"thunder":case"flashget":case"qqdl":e=e.slice(t.length+3).split("&",1)[0];break;default:return""}try{e=atob(e)}catch(e){return""}return e.startsWith("AA")&&e.endsWith("ZZ")&&(e=e.slice(2,-2)),e.startsWith("[FLASHGET]")&&e.endsWith("[FLASHGET]")&&(e=e.slice(10,-10)),_(e)||e}function T(){console.log("Failed to visit the predicted URL, so go back to the original version."),k(),VData.auto=!1,e()}function k(){let e=!1;return VData.auto==="once"&&(VData.auto=!1,e=!0),e&&R(),e}function R(e){let t=VData.type;if(!t)return;let n="#!"+t+" "+(VData.incognito?"incognito=1&":"")+(VData.file?"download="+A(VData.file)+"&":"")+(VData.rawSrc?"src="+A(VData.rawSrc)+"&":"")+(VData.auto?"auto="+(VData.auto==="once"?"once":1)+"&":"")+(VData.pixel?"pixel=1&":"")+VData.original;if(VData.full=n,e)return;let i=I(n,re,!0);history.replaceState(i,"","")}function A(e){return e.replace(new RegExp("[^\\p{L}\\p{N}]+","ug"),encodeURIComponent)}function I(e,t,n){if(t===-1)return e;let i=[];if(n)e=encodeURIComponent(e);else try{e=atob(e)}catch(t){e=""}for(let t of e)i.push(t.charCodeAt(0));for(let e=0;e<i.length;e++)i[e]=255&(i[e]^t>>>8*(e&3));if(e=String.fromCharCode(...i),n)e=btoa(e);else try{e=decodeURIComponent(e)}catch(t){e=""}return e}function L(){return VData&&VData.full?location.href.split("#",1)[0]+VData.full:location.href}import{CurCVer_ as U,CurFFVer_ as z,OnChrome as j,OnFirefox as C,OnEdge as V,$,pageTrans_ as P,browser_ as S,nextTick_ as H,enableNextTick_ as M,import2_ as E,isVApiReady_ as F,post_ as O,disconnect_ as B,simulateClick_ as W,hasShift_ as q,setupPageOs_ as G,isRepeated_ as N,prevent_ as Z}from"./async_bg.js";let X,Y,D,VData=null,J=!0,K={},Q=document.body,ee=null,te=$("#bgLink"),ne=null,ie=null,re=+window.name||0,oe=!1,le=!1,ae=/\.(?:avif|bmp|gif|icon?|jpe?g|a?png|svg|tiff?|webp)(?=[.\-_]|\b)/i,se="",ue=null;export const sTrans_=(e,t)=>P(e,t)||"";M(1),F.then(()=>{VApi.u=L}),H(()=>{window.onhashchange=e,window.onpopstate=e,e().then(()=>{F.then(B)}),O(31).then(e=>{G(e.os)})}),window.onpagehide=v,Q.ondrop=t=>{let n=t.dataTransfer.files;if(n.length===1){let i=n.item(0),r=i.name;(i.type.startsWith("image/")||ae.test(r))&&(Z(t),D="#!image download="+A(r)+"&"+URL.createObjectURL(i),e())}},Q.ondragover=Q.ondragenter=e=>{let t=e.dataTransfer.items;t.length===1&&t[0].type.startsWith("image/")&&Z(e)},document.addEventListener("keydown",t=>{if(VData.type==="image"&&i(t))return;if(!t.ctrlKey&&!t.metaKey||t.altKey||N(t)||q(t))return;let r=String.fromCharCode(t.keyCode);if(r==="S")n({download:VData.file||""},t);else if(r==="C")f(t);else if(r==="A")d(t);else if(r==="O"){Z(t);let n=document.createElement("input");n.type="file",n.accept="image/*",n.onchange=()=>{let t=n.files&&n.files[0];t&&(D="#!image download="+A(t.name)+"&"+URL.createObjectURL(t),e())},document.body.append(n),setTimeout(()=>{n.remove()},0),n.click()}});let fe=e=>{let t=e.slice(0,20).toLowerCase();return!(t.startsWith("blob:")||t.startsWith("data:")&&e.length>1e4)&&(!/^(ht|s?f)tp|^data:/.test(t)||!VData.incognito&&O(5,{key:"showInIncognito"}).then(e=>!e))};