import{$ as e,OnEdge as o,browser_ as t,OnFirefox as n,OnChrome as i,nextTick_ as s,CurCVer_ as r,IsEdg_ as l,post_ as a,pageLangs_ as m,prevent_ as p}from"./async_bg.js";import{Option_ as c,oTrans_ as u,bgSettings_ as d,delayBinding_ as f}from"./options_base.js";import{registerClass_ as _,createNewOption_ as h,TextOption_ as v}from"./options_defs.js";let b=t.permissions,g=e=>{if(!b)return function(){return a(25,{module:"permissions",name:e,args:[].slice.call(arguments)})};let o=b[e];return function(){let e=[].slice.call(arguments);return o.apply(b,e).then(e=>[e,void 0],e=>[void 0,e])}},P={contains:g("contains"),request:g("request"),remove:g("remove")},O=null,y="downloads.shelf",w="chrome://new-tab-page/*",k="chrome://*/*",x={"clipboard-read":"opt_clipboardRead",[k]:"opt_chromeUrl",[w]:"opt_cNewtab",[y]:"opt_closeShelf"},S=e("#optionalPermissionsTemplate"),j=S.content.firstElementChild,q=S.parentElement,C=null,F=null,N=[];export const manifest_=t.runtime.getManifest();let E=manifest_.optional_permissions||[],H=[];export class OptionalPermissionsOption_ extends c{e(){f(this.P,"change",this.J)}R(){return N.map(e=>e.P.indeterminate?"1":e.P.checked?"2":"0").join("")}H(){return N.map(e=>e.z).join("")}c(e){for(let o=0;o<N.length;o++){let t=N[o];t.P.checked=e[o]==="2",t.P.indeterminate=e[o]==="1"}}f(e){let o=[],t=[],n={},i=1;for(let s=0;s<N.length;s++){let r=N[s],l=+e[s];if(r.z===l)continue;let m="";r.z=l,r.pe===2||(l?(r.de===y&&o.push("downloads"),(r.pe===1?t:o).push(r.de),m&&t.push(m),n[r.de]=r):(i++,P.remove(r.pe===1?{origins:m?[r.de,m]:[r.de]}:{permissions:r.de===y?["downloads",r.de]:[r.de]}).then(([e,o])=>{let t="Can not remove the permission %o : ",n=o&&o.message||o;(o||!e)&&console.log(t,r.de,n);let i=r.P.parentElement;v.ae(o?t.replace("%o",r.de)+n:"",void 0,i),a()})))}let r=(e,[o,t])=>{if((t||!o)&&console.log("Can not request permissions of %o :",e,t&&t.message||t),!o){for(let o of e){let e=n[o];if(!e)continue;e.z=0;let i=e.P.parentElement;if(!t){v.ae("",void 0,i);continue}let r=(t&&t.message||JSON.stringify(t))+"";o.startsWith("chrome://")&&r.includes("Only permissions specified in the manifest")&&o.startsWith("chrome:")&&(r=u("optNeedChromeUrlFirst"),r=l?r.replace("chrome","edge"):r),r=u("exc")+r,v.ae(r,void 0,i),s(()=>{i.title=r})}this.j()}a()},a=()=>{i--,i>0||Promise.all(N.map(U)).then(()=>{this.j()})};if(i+=(o.length&&1)+(t.length&&1),o.length&&P.request({permissions:o}).then(r.bind(0,o)),t.length&&P.request({origins:t}).then(r.bind(0,t)),[].includes("clipboard-read")){let e=navigator.clipboard;i++,e.readText().catch(()=>{}).then(a)}return a(),Promise.resolve(e)}}_("OptionalPermissions",OptionalPermissionsOption_);let T=()=>{let o=document.createDocumentFragment(),t=N.some(e=>e.de==="bookmarks");for(let e of N){let n=e.de,i=document.importNode(j,!0),s=i.querySelector("input"),r=u(x[n]||`opt_${n}`)||n,l="";s.name=n,t&&(l+=u("rec_perm")),s.nextElementSibling.textContent=r+l,n=="bookmarks"&&o.childElementCount+1<N.length&&(i.classList.add("after-importants"),t=!1),o.append(i),e.P=s}E.length===1||E.length===2&&m==="en"||(e("#optionalPermissionsHelp").classList.add("has-many"),q.classList.add("has-many")),q.append(o),f(q,"input",J,!0),F&&f(F,"click",M,!0)},U=e=>{let{pe:o,de:t}=e;return(o===2?Promise.resolve([1,void 0]):P.contains(o===1?{origins:[t]}:{permissions:t===y?["downloads",t]:[t]})).then(([o])=>{e.z=o?e.pe===2?o:2:0})},J=e=>{let o=e.target;N.find(e=>e.P===o)||o.localName!=="label"&&o.parentElement.localName!=="label"||(p(e),e.stopImmediatePropagation())},M=e=>{p(e),a(15,{u:e.target.href,p:!1})};{let e=[y];e.push(/^chrome:/,"contentSettings"),E=E.filter(o=>!e.some(e=>typeof e=="string"?o===e:e.test(o)))}if(E.length){for(let e of E)N.push({de:e,pe:e.includes(":")?1:0,z:0,P:null});s(T,9),Promise.all(N.map(U)).then(()=>{s(()=>{q.dataset.model="OptionalPermissions",h(q).j()})})}else s(()=>{e("#optionalPermissionsHelp").style.display="none"},9);s(([e,o])=>{t.extension.isAllowedIncognitoAccess?(t.extension.isAllowedIncognitoAccess(o=>{e.checked=o}),t.extension.isAllowedFileSchemeAccess(e=>{o.checked=e})):a(33).then(([t,n])=>{e.checked=t,o.checked=n}),o.onclick=e.onclick=e=>{p(e),alert(u("haveToOpenManually")+"\n  about:addons")}},[e("#in-incognito"),e("#on-file-urls")]);