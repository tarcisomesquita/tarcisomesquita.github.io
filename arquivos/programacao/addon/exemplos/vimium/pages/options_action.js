import{OnFirefox as e,OnEdge as t,OnChrome as l,$ as n,pageTrans_ as s,enableNextTick_ as o,nextTick_ as i,IsEdg_ as u,post_ as r,toggleReduceMotion_ as a,hasShift_ as c,PageOs_ as p,setupPageOs_ as h,prevent_ as d,CurCVer_ as m,escapeAllForRe_ as f}from"./async_bg.js";import{bgSettings_ as _,ExclusionRulesOption_ as w,setupBorderWidth_ as v,showI18n_ as b,setupSettingsCache_ as g}from"./options_base.js";let y,R,k,x,j="",O=0,P=!0,T=null,E=null,L=0,S=/^[a-z][\+\-\.\da-z]+:\/\//,D=n("#state-action"),N=n("#saveOptions"),U=D.nextElementSibling,$=U.nextElementSibling,z=Object.create(null),A=(e,t)=>s(e,t)||"";class H extends w{e(e){super.e(e),this.l.onmousedown=e=>{e.detail>1&&e.target.localName!=="input"&&d(e)}}n(e,t){super.n(H.o(),t)}i(e){return e.r=e.a.pattern&&z[e.a.pattern]||!1,F(e.r)}c(e){super.c(e),H.prototype.c=null,H.prototype.i=w.prototype.i;let t,l=this.h.filter(e=>e.d),n=l.length>0;O=n?2:1,n?(t=l[0].m,V(!0)):(this.n("",!1),t=this.h[this.h.length-1].m),setTimeout(()=>{t.focus()},67)}f(e){let t=super.f(e),l=q(`${y.tabId}/reset/silent`);return Promise.all([t,l]).then(([e])=>e)}w(e,t,l){let n=e.a.pattern===t,s=e.r;super.w(e,t,l);let o=t?l?l.length>1&&l[0]==="^"?A("onlyHook")||"only hook such keys":A("passThrough")||"pass through such keys":A("completelyDisabled")||"completely disabled":"";e.b.title!==t&&(e.b.title=t),e.m.title!==o&&(e.m.title=o),n?e.r=s:this.g(e,t)}g(e,t){let l,n=e.b;e.y&=-5,t&&t!==H.o()?(l=G(e))instanceof Promise?l.then(this.g.bind(this,e,t)):F(l)?n.title=n.style.color="":(e.y|=4,n.style.color="red",n.title="Red text means that the pattern does not\nmatch the current URL."):n.title=n.style.color=""}static o(){let e=y.hasSubDomain,t=(e?j:R).split(/[?#]/)[0],l=e||t.startsWith("http:")?(e<2&&t[4]!==":"?"^https://":"^https?://")+(e?"(?:[^/]+.)?":"")+f(t.split("/",3)[2])+"/":t.startsWith(location.origin+"/")?":vimium:/"+new URL(t).pathname.replace("/pages",""):/^[^:]+:\/\/./.test(t)&&!t.startsWith("file:")?":"+t.split("/",3).join("/")+"/":":"+t;return z[l]||(z[l]=J(l[0]==="^"?{t:1,v:l}:{t:2,v:l.startsWith(":vimium:")?t:l.slice(1)})),H.o=()=>l,l}}let V=e=>{E.R(!0);let t=E.h.filter(e=>e.d&&(!!e.a.pattern||!!(e.y&4))),l=O;O=2,Promise.all(t.map(e=>e.r!==null?e.r:G(e))).then(()=>{C(l,e,t)})},C=(e,t,l)=>{let n=e===3,s=Q(!!j,l);s&&(s=M(s)),t&&(T=e>=2?s:null);let o=s===T,i=!!s&&s.length>2&&s[0]==="^";D.textContent=(n?s?A("137")+A(i?"138":"139"):A("140"):A(o?"141":"142")+A(s?i?"138":"139":o?"143":"143_2")).replace(" to be","")+A("colon")+A("NS"),U.className=s?"code":"",U.textContent=s?i?s.slice(2):s:A("143_3")+A(s!==null?"144":"145"),$.textContent=y.lock!==null&&!n&&o?A("147",[A(y.lock!==0?"144":"145")]):y.lock!==null?A("148"):"";let u=l.some(e=>!!(e.y&4)&&(e.a.pattern!==e.k.pattern||e.a.passKeys!==e.k.passKeys));N.disabled=o&&!u,N.firstChild.data=A(n?"115_3":o&&!u?"115":"115_2")},I=()=>{if(!N.disabled)return o(8),E.x().then(()=>{o(0,8),O=3,W(),V(!0),N.firstChild.data=A("115_3"),N.blur(),N.disabled=!0,P=!0})},M=e=>{let t=(e=e.trim()).length>2&&e.startsWith("^");t&&(e=e.slice(1).trimLeft());let l=Object.create(null);for(let t of e.split(" "))l[t==="*"?A("asterisk"):t]=1;return(t?"^ ":"")+Object.keys(l).sort().join(" ")},q=e=>r(22,[e,y.tabId,y.frameId]).then(e=>{y.status=e[0],y.lock=e[1]}),B=(e,t)=>{t&&d(t);let l=t&&(t.ctrlKey||t.metaKey);q(`${y.tabId}/${e}`).then(()=>{l?(W(),V(!1)):window.close()})},F=e=>!!e&&(e.t===2?R.startsWith(e.v)||!!j&&j.startsWith(e.v):e.t===3?e.v.p.test(R)||!!j&&e.v.p.test(j):e.v.test(R)||!!j&&e.v.test(j)),G=e=>{let t=e.a.pattern,l=z[t];if(l)return e.r=l instanceof Promise?l.then(t=>e.r=t):l;let n=r(23,t);return z[t]=e.r=n.then(l=>z[t]=e.r=J(l))},J=e=>e.t===2?{t:e.t,v:e.v}:e.t===3?{t:e.t,v:{p:new URLPattern(e.v,"http://localhost",{ignoreCase:!0}),s:e.v}}:{t:e.t,v:new RegExp(e.v,"")},K=()=>{let{rules:e,matchers:t}=y.exclusions;for(let l=0,n=e.length;l<n;l++){let n=e[l].pattern;z[n!=="__proto__"?n:"_"]=J(t[l])}},Q=(e,t)=>{let l="";for(let e of t){let t=e.r;if(t&&(t.t===2?R.startsWith(t.v):t.t===3?t.v.p.test(R):t.v.test(R))){let t=e.a.passKeys;if(t.length===0||x||t[0]==="^"&&t.length>2)return t;l+=t}}return!l&&e&&R.lastIndexOf("://",5)<0&&!S.test(R)&&j?Q(!1,t):l||null},W=()=>{k=y.status!==2?"Disable":"Enable";let e=n("#toggleOnce"),t=e.nextElementSibling;i(()=>{e.firstElementChild.textContent=(A(k)||k)+(y.lock!==null?"":A("Once")),e.onclick=B.bind(null,k),U.id="state-value",t.classList.toggle("hidden",y.lock===null),y.lock!==null&&(t.firstElementChild.onclick=B.bind(null,"Reset"))})},X=e=>{let t=n(".options-link"),l=location.origin+"/pages/options.html";e.startsWith(l)?i(()=>{t.nextElementSibling.remove(),t.remove()}):(t.href!==l&&i(()=>{t.href=l}),t.onclick=e=>{d(e),r(15,{u:l,p:!0}).then(()=>{window.close()})})},Y=()=>{window.addEventListener("keydown",e=>{e.keyCode===13&&e.metaKey?Z(e):e.altKey&&(e.keyCode===88||y.lock!==null&&e.keyCode===90)&&!(e.ctrlKey||e.metaKey||c(e))&&(d(e),e.stopImmediatePropagation(),B(e.keyCode===88?k:"Reset"))}),E=new H(n("#exclusionRules"),()=>{if(P){P=!1;let e=!L&&n("#helpSpan");e&&(e.nextElementSibling.style.display="",e.remove(),L=1)}V(O<2)}),E.j()};r(20).then(e=>{y=e,h(y.os);let t=y.url,l=n("#blocked-msg");if(o(1),!y.runnable)return te(l),X(t),i(b),void i(ee);i(e=>{l.remove(),l=null,a(y.reduceMotion),e.textContent=y.ver},n("#version")),j=y.topUrl||t,R=y.frameUrl||j,x=y.exclusions.onlyFirst,_.O={exclusionRules:y.exclusions.defaults},g({exclusionRules:y.exclusions.rules}),K(),y.exclusions=null,N.onclick=I,document.addEventListener("keyup",Z),X(t),W(),Y(),i(b),v&&i(v),i(ee)});let Z=e=>{if(e.keyCode===13){let t=e.target;if(t instanceof HTMLAnchorElement)t.hasAttribute("href")||setTimeout(e=>{e.click(),e.blur()},0,t);else if(e.ctrlKey||e.metaKey){let e=!P&&I();e&&e.then(()=>{setTimeout(window.close,300)})}}},ee=()=>{let e=document.documentElement;e.classList.remove("loading"),e.style.width="",e.style.height=""},te=e=>{let t=document.body;t.innerText="",e.style.display="",e.querySelector("#version").textContent=y.ver,e.querySelector("#refresh-after-install").remove(),t.append(e);let l=y.unknownExt;if(l){let e=n("#injection-refused");e.style.display="",e.nextElementSibling.remove(),n("#doAllowExt").onclick=function(){this.onclick=null,r(21,[y.tabId,l]).then(()=>{setTimeout(()=>{location.reload()},0)})}}let s=n("#retryInject");s&&(s.nextElementSibling.remove(),s.remove())};