function e(e){return new Date(+e-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," ")}function t(e,t){return t&&(e==="omniBlockList"||n(t))?"$base64:"+btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))):t}function n(e){if(D==null){let e=[];for(let t of S.$("omniBlockList").split("\n"))t.trim()&&t[0]!=="#"&&e.push(t);D=e.length>0&&new RegExp(e.map(e=>v(e)).join("|"),"")}return D!==!1&&D.test(e)}function o(e){return e instanceof Array&&(e=e.join("\n").trimRight()),(e=e.replace(/\r\n?/g,"\n").replace(/\xa0/g," ")).replace(/^\$base64:(.*)/gm,(e,t)=>{try{return decodeURIComponent([].map.call(atob(t),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(e){}return e})}async function i(t,n,i){let l=n.environment,r=l&&l.platform||"",s=l&&l.extension&&l.extension+""||"",a=parseFloat(s||0)||0,f=a>1?s.split(".",2).join("."):"",u=a>parseFloat(A.version);if(r&&(r=(""+r).slice(0,10)),!confirm(j("confirmImport",[j(i!==!0?"backupFile":"recommendedFile"),f?j("fileVCVer").replace("*",f):"",(f?j("fileVCVer_2").replace("*",f):"")+(u?j("fileVCNewer"):""),r?j("filePlatform",[j(r)||r[0].toUpperCase()+r.slice(1)]):j("commonPlatform"),t?j("atTime",[e(t)]):j("before")])))return void(VApi&&VApi.h(1,0,j("cancelImport")));let c=new Date,m=H(c,!1);Object.setPrototypeOf(n,null);{let e=n.firefox;e&&typeof e=="object"&&Object.assign(n,e)}if(n.vimSync==null){let e=S.$("vimSync"),t=e&&confirm(j("keepSyncing"));n.vimSync=t||e==null&&null,e&&console.log("Before importing: You chose to",t?"keep settings synced.":"stop syncing settings.")}let p=function(e,t,n,o){let i=arguments.length>3,l=i?o:n,r=["%s %c%s",e,"color:darkred",t];l=typeof l!="string"||l.length<=72?l:l.slice(0,71).trimRight()+" \u2026",i&&r.push(n),r.push(l),d++,console.log.apply(console,r)},d=0;console.group("Import settings at "+e(+c+1)),g(8),t>1e4?console.info("load settings saved at %c%s%c.","color:darkblue",e(t),"color:auto"):console.info("load the settings:",i?"recommended.":"saved before.");let y=e=>e.split(/\s+/g).forEach(e=>e&&delete n[e]);y("name time environment author description chrome chromium firefox edge safari");for(let e in n)e[0]==="@"&&delete n[e];let w=e=>{let t=n[e];typeof t=="string"&&t.includes("extension://",2)&&(/^moz-/.test(t)||delete n[e])};w("vomnibarPage"),w("newTabUrl");let h=C(),v=S.O,V=O.X;for(let e in h)h[e]===v[e]||e in n||(n[e]=null);y("findModeRawQueryList innerCSS findCSS omniCSS newTabUrl_f vomnibarPage_f\n      focusNewTabContent dialogMode"),y("i18n_f");let _={__proto__:null,extWhiteList:"extAllowList",phraseBlacklist:"omniBlockList"};for(let e in _)e in n&&(n[_[e]]=n[e],delete n[e]);if(n.keyLayout==null){let e=n[P[0]],t=n[P[1]],o=n[P[2]];if(e!==void 0||t!==void 0||o!==void 0){let i;e=e!==null?e+"":e,t=t!==null?t+"":t,o=o!==null?o+"":o,i=e==null?4:e==="2"||e==="true"?1:e==="1"?12:4,i|=t==null||i===1?0:t==="2"||t==="true"?16:t==="1"?512:0,i|=o==null?0:o==="2"?128:o==="1"?64:0,i|=256,n.keyLayout=i}}for(let e of P)delete n[e];n.vimSync!==S.$("vimSync")&&(p("import","vimSync",n.vimSync),await S.N("vimSync",n.vimSync),await V.vimSync.j());{let e=V.keyMappings;e!==void 0&&(delete V.keyMappings,V.keyMappings=e)}if(await Promise.all(Object.values(V).map(async e=>{let t=e.K,i=n[t];if(delete n[t],t in v)return i==null?i=v[t]:(typeof v[t]=="string"&&(i=o(i)),i=await e.A(i)),e.Q(await e.H(),i)?e.L?void 0:e.j():(p("import",t,i),await S.N(t,i),t in S.B&&O.U.push(t),await e.j(),e.C())})).catch(e=>{p("[ERROR] importing options failed","cause:",e)}),await Promise.all(Object.keys(n).map(async e=>{let t=n[e];if(t==null)if(e in v){if(t=v[e],S.$(e)!==t)return p("reset",e,t),S.N(e,t)}else if(e.includes("|"))return p("remove",e,"(from local)"),b(28,{key:e,val:null});if(typeof v[e]=="string"&&(t=o(t)),e in v){if(S.$(e)!==t)return p("update",e,t),S.N(e,t)}else if(e.includes("|"))return t=""+t,p("save",e,t),b(28,{key:e,val:t})})).catch(e=>{p("[ERROR] saving fields failed","cause:",e)}),g(0,8),await 0,k.onclick(!1),d<=0)console.info("no differences found.");else if(m.options>0){let e=B(m.text);console.info("[message] you may recover old configuration of %d option(s), by open the %s URL below ON THIS TAB:\n%c%s",m.options,e.slice(0,5),"color: #15c;",e)}console.info("import settings: finished."),console.groupEnd();let L=VApi&&VApi.y().r;L&&L.querySelector("#HCls")&&E("force"),VApi&&VApi.h(1,0,j("importOK"))}function l(e,t,n){let o=null,l=null,s="";try{let e=r(n?t:t.replace(/\xa0/g," "));e instanceof Error?l=e:e?o=e:s=j("notJSON")}catch(e){l=e}if(l!=null){s=l?(l.message||l)+"":j("exc")+(l!==""?l:j("unknown"));let e=/^(\d+):(\d+)$/.exec(s);s=e?j("JSONParseError",[e[1],e[2]]):s}if(!o)return alert(s);if(e=+new Date(o.time||(typeof e=="object"?+e:e))||0,o.name!=="Vimium C"&&o.name!=="Vimium++"||e<1e4&&e>0)return s=j("notVCJSON"),alert(s);let a=O.X.keyMappings.q?Promise.resolve():p("./options_checker.js"),f=e,u=o;a.then(()=>{setTimeout(i,17,f,u,n)})}function r(e){function t(){return/a?/.test("")}function n(e){let t=e.length;for(;f.length<t;f+=f);return f.slice(0,t)}let o=/[^\r\n]+/g,i=/\b(?:position (\d+)|line (\d+) column (\d+))/,l=/"(?:\\[^\r\n]|[^"\\\r\n])*"|'(?:\\[^\r\n]|[^'\\\r\n])*'|(?:\/\/|#)[^\r\n]*|\/\*[^]*?\*\//g;if(!e||!(e=e.trimRight()))return null;let r,s,a,f=" ";try{let i=JSON.parse(e.replace(l,e=>{let t=e[0];return t==="/"||t==="#"?e.startsWith("/*")?e.replace(o,n):n(e):e}));return t(),i}catch(e){if(r=i.exec(e+""),t(),!r||!r[0])throw e}if(r[2])s=+r[2],a=+r[3];else if(+r[1]>0){let t=e.includes("\r")?e.includes("\r\n")?"\r\n":"\r":"\n",n=e.slice(0,+r[1]).split(t);s=n.length,a=n[s-1].length+1}else s=a=1;return new SyntaxError(s+":"+a)}import{CurCVer_ as s,CurFFVer_ as a,OnChrome as f,OnEdge as u,OnFirefox as c,$ as m,import2_ as p,OnSafari as d,enableNextTick_ as g,isVApiReady_ as y,simulateClick_ as w,post_ as b,prevent_ as h,escapeAllForRe_ as v}from"./async_bg.js";import{bgSettings_ as S,ExclusionRulesOption_ as V,Option_ as O,oTrans_ as j,getSettingsCache_ as C}from"./options_base.js";import{exportBtn_ as _,saveBtn_ as k}from"./options_defs.js";import{manifest_ as A}from"./options_permissions.js";import{delayed_task as L,clear_delayed_task as R,onHash_ as x,noBlobSupport_cr_mv2_ as T}from"./options_wnd.js";let P=["ignoreKeyboardLayout","ignoreCapsLock","mapModifier"],B=e=>{let t=new Blob([e],{type:"application/json",endings:"native"});return URL.createObjectURL(t)},E=e=>{if(!VApi||!VApi.z)return void y.then(E.bind(null,e));let t,n=VApi.y().r,o=!1;if(e&&e!=="force"&&h(e),n&&(t=n.querySelector("#HCls"))){if(e!=="force"&&n.querySelector(".HelpCommandName")!=null)return void w(t);let i=n.querySelector("#HDlg"),l=i&&i.parentElement||i;o=!!l&&l.remove!==HTMLElement.prototype.remove,l&&(l.remove=HTMLElement.prototype.remove)}VApi.r[0](40,{i:1,q:[{n:24,q:null}]},o||location.hash==="#commands"?()=>{let e=VApi&&VApi.y(),t=e&&e.r&&e.r.querySelector("#HDlg");if(!t)return;let n=t.parentElement||t;n.remove=()=>{HTMLElement.prototype.remove.call(n),location.hash="",m("#optionalPermissionsBox").style.display!="none"&&x("#optionalPermissions")}}:()=>{})};m("#showCommands").onclick=E,V.prototype.fe=function(e){if(e&&this.ue)return;let t,n,o=this.R(),i=/^([:^]?[a-z\-?*]+:\/\/)?((?:[^\/]|\/])+)(\/[^\]].*|\/?$)/;for(let e of o)(n=i.exec(t=e.pattern.replace("(?:[^./]+\\.)*?","*.")))&&n[1]&&n[2]&&(t=n[3]?n[3].replace(/\\\./g,"."):"",n=n[2].replace(/\\\./g,".").split("."),n.reverse(),t=n.join(".")+t),e.me=t;if(o.sort((e,t)=>e.me<t.me?-1:e.me===t.me?0:1),this.c(o),this.J(),!e)return;let l=this;this.ue=setTimeout((e,t)=>{e.firstChild.data=t,l.ue=0},1e3,e,e.firstChild.data),e.firstChild.data=j("3_2")},m("#exclusionSortButton").onclick=function(){O.X.exclusionRules.fe(this)};let N="",H=(e,n)=>{let o;o=Object.create(null),o.name="Vimium C",n||(o["@time"]=e.toLocaleString(),o.time=e.getTime()),o.environment={extension:A.version,platform:S.S},o.environment.firefox=a;let i=C(),l=S.O,r=Object.keys(i).sort();D=null;for(let e of r){let n=i[e],r=l[e];n!==r&&(typeof r!="string"?o[e]=n:n.includes("\n")?(o[e]=n.split("\n").map(n=>t(e,n))).push(""):o[e]=t(e,n))}if(D=null,o.keyLayout!=null){let e=o.keyLayout;e&9&&(o[P[0]]=e&8?1:2),e&528&&(o[P[1]]=e&512?1:2),e&192&&(o[P[2]]=e&64?1:2)}let s=JSON.stringify(o,null,"\t")+"\n",f=s.split("\n");for(let e=0;e<f.length;e++)if(f[e].replace(/[\u4e00-\u9fff]/g,"  ").length+1>120&&/^\s+"\w+":/.test(f[e])){let t=f[e].split(":",1)[0]+":",n=f[e].slice(t.length).trimLeft();n=n.replace(/[\u4e00-\u9fff]/g,"  ").length+4>120?n:"\t\t"+n,f[e]=t+"\n"+n}return s=f.join("\n"),o.environment.platform==="win"&&(s=s.replace(/\n/g,"\r\n")),{text:s,options:r.length}};_.onclick=t=>{N&&(URL.revokeObjectURL(N),N="");let n=new Date,o=!!t&&(t.ctrlKey||t.metaKey||t.shiftKey),i=H(n,o).text,l=e(n),r="vimium_c-";r+=o?"settings":l.replace(/[\-:]/g,"").replace(" ","_"),r+=".json";{let e=document.createElement("a");e.download=r,e.href=B(i),w(e),N=e.href}console.info("EXPORT settings to %c%s%c at %c%s%c.","color:darkred",r,"color:auto","color:darkblue",l,"color:auto")};let D=null,F=m("#settingsFile");F.onclick=null,F.onchange=function(){let e=this.files[0];if(this.value="",!e)return;let t=O.X.vimSync.z?102400:10485760;if(e.size&&e.size>t)return void alert(j("JSONTooLarge",[e.name,t/1024]));let n=new FileReader,o=e.lastModified||e.lastModifiedDate||0;n.onload=function(){return l(o,this.result,!1)},n.readAsText(e)};let I=m("#importOptions");I.onclick=null,I.onchange=function(){m("#importButton").focus(),this.value!=="exported"?fetch("../settings-template.json").then(e=>e.text()).then(e=>l(0,e,!0)):w(F)},L&&(()=>{let e=L;R();let t=m(e[0]);t.onclick&&t.onclick(e[1])})();