<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Armazenamento de Dados Binários com IndexedDB</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Armazenamento de Binário (IndexedDB)</h1>
    <p>O arquivo para download é: <code>https://tarcisomesquita.github.io/tarciso.bin</code></p>
    
    <button id="btnDownload">1. Baixar e Salvar Arquivo</button>
    <button id="btnRead">2. Ler Arquivo do IndexedDB</button>

    <div id="status">Status: Pronto.</div>

    <script>
        // CONFIGURAÇÕES DO BANCO DE DADOS
        const DB_NAME = 'BinaryStorageDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'BinaryFiles';
        const FILE_URL = 'https://tarcisomesquita.github.io/tarciso_2024-09.jpg';
        const FILE_KEY = 'tarciso_bin_file'; // Chave sob a qual o arquivo será salvo

        const statusElement = document.getElementById('status');

        /**
         * Abre a conexão com o IndexedDB e cria a Object Store, se necessário.
         * @returns {Promise<IDBDatabase>} A promessa de conexão com o banco de dados.
         */
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    reject('Erro ao abrir o IndexedDB: ' + event.target.error);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    // Cria a Object Store para armazenar os Blobs
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
            });
        }

        /**
         * Realiza o download do arquivo binário e o salva no IndexedDB.
         */
        async function downloadAndStore() {
            statusElement.textContent = 'Status: Baixando o arquivo...';

            try {
                // 1. DOWNLOAD USANDO FETCH
                const response = await fetch(FILE_URL);
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status} ${response.statusText}`);
                }
                
                // 2. CONVERTER PARA BLOB (Objeto Binário)
                const fileBlob = await response.blob();
                statusElement.textContent = `Status: Download concluído. Tamanho: ${Math.ceil(fileBlob.size / 1024)} KB. Iniciando armazenamento...`;
                
                // 3. ABRIR DB E INICIAR TRANSAÇÃO
                const db = await openDatabase();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // 4. ARMAZENAR O BLOB
                const request = store.put(fileBlob, FILE_KEY);

                request.onsuccess = () => {
                    statusElement.textContent = 'Status: ✅ Arquivo binário salvo com sucesso no IndexedDB!';
                };

                request.onerror = (event) => {
                    statusElement.textContent = 'Status: ❌ Erro ao salvar no IndexedDB: ' + event.target.error;
                };

            } catch (error) {
                statusElement.textContent = `Status: ❌ Erro Fatal: ${error.message}`;
                console.error(error);
            }
        }

        /**
         * Lê o arquivo binário armazenado no IndexedDB.
         */
        async function readFile() {
            statusElement.textContent = 'Status: Tentando ler arquivo do IndexedDB...';

            try {
                const db = await openDatabase();
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                // RECUPERAR O BLOB
                const request = store.get(FILE_KEY);

                request.onsuccess = (event) => {
                    const retrievedBlob = event.target.result;

                    if (retrievedBlob instanceof Blob) {
                        statusElement.textContent = `Status: ✅ Arquivo lido com sucesso! Tipo: ${retrievedBlob.type || 'application/octet-stream'}, Tamanho: ${Math.ceil(retrievedBlob.size / 1024)} KB.`;
                        
                        // Opcional: Aqui você pode usar o FileReader para ler o conteúdo do Blob,
                        // ou criar uma URL de objeto (URL.createObjectURL) para exibição.
                        console.log("Objeto Blob recuperado:", retrievedBlob);
                    } else {
                        statusElement.textContent = 'Status: ⚠️ Arquivo não encontrado no IndexedDB. Por favor, clique no primeiro botão.';
                    }
                };

                request.onerror = (event) => {
                    statusElement.textContent = 'Status: ❌ Erro ao ler do IndexedDB: ' + event.target.error;
                };
            } catch (error) {
                statusElement.textContent = `Status: ❌ Erro Fatal na leitura: ${error.message}`;
            }
        }

        // EVENT LISTENERS
        document.getElementById('btnDownload').addEventListener('click', downloadAndStore);
        document.getElementById('btnRead').addEventListener('click', readFile);
    </script>
</body>
</html>