
How to measure the code coverage
----------------------------------

Let's assume for simplicity that you're going to use the default `build`
directory. Of course it's possible to have a build directory anywhere else.

0. We need to do a completely clean build. Run:

        rm -rf ./build

1. Now we need to install the optional `lcov` component in the toolchain with:

        ./scripts/build_toolchain -s build_lcov

   Clearly, this needs to be done only once.

2. Setup the build configuration by running Tilck's CMake wrapper script:

        TEST_GCOV=1 KERNEL_GCOV=1 ./scripts/cmake_run

3. Now build Tilck:

        make -j

4. And its unit tests:

        make -j gtests

5. At this point, we can run the unit tests:

        ./build/gtests

   As a result, a fair amount of .gcda files will be generated. We can list
   them with:

        find ./build -name '*.gcda'

   Even if there's no point in doing that, other than checking that everything
   is fine.

6. Now can finally generate the first coverage report with:

        ./scripts/generate_test_coverage_report

   In the `./build` directory, there should be now a `coverage.info` file, but
   we're not done yet. We have only coverage for the unit tests.

7. In order to get coverage info for the self tests and the system tests, we
   need to run also:

        DUMP_COV=1 REPORT_COV=1 ./st/run_all_tests -c

8. At this point, our `coverage.info` file will contain the merge coverage data
   from both the unit tests run and all the other tests (were kernel coverage
   was involved). Therefore, we can finally generate our HTML report this way:

        ./scripts/generate_test_coverage_report --gen

   Open `./build/coverage_html/index.html` in our browser.


**WARNING**
The order of steps 5..8 cannot be simply changed. In other words, we *cannot*
first run the system tests and then the unit tests using the same commands
because the execution of `generate_test_coverage_report` in step 6 will delete
the `coverage.info` file, generated by the system tests. If case we really need
to first run the system tests, we have to:

   - Be sure to delete `converage.info` before running the system tests:

         rm -f ./build/converage.info

   - Run the system tests as before:

         DUMP_COV=1 REPORT_COV=1 ./st/run_all_tests -c

   - Then run the unit tests as before with:

         ./build/gtests

   - But now generate the coverage report with the `--acc` option:

         ./scripts/generate_test_coverage_report --acc

     which will accumulate the results, instead of erasing first the
     `coverage.info` file.

   - Finally, we can generate the HTML report as before:

         ./scripts/generate_test_coverage_report --gen
